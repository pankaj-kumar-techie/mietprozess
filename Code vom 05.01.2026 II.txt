import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc } from 'firebase/firestore';

// Initialisierung der Firebase-Konfiguration
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Konstanten ---

const STATUS_OPTIONS = [
  'In Kündigung',
  'In Vermietung',
  'Mietvertrag erstellt',
  'Wohnung übergeben',
  'Abgeschlossen'
];

const STATUS_COLORS = {
  'In Kündigung': 'bg-red-50 border-red-200 text-red-700',
  'In Vermietung': 'bg-yellow-50 border-yellow-200 text-yellow-700',
  'Mietvertrag erstellt': 'bg-green-50 border-green-200 text-green-700',
  'Wohnung übergeben': 'bg-blue-50 border-blue-200 text-blue-700',
  'Abgeschlossen': 'bg-gray-100 border-gray-300 text-gray-700'
};

const TEAM_MEMBERS = ['Kein Zuständiger', 'Max Mustermann', 'Erika Musterfrau', 'Hans Schmidt', 'Anna Meier'];
const RELETTING_OPTIONS = ['Ja Weitervermietung', 'Nein Nachmieter vorhanden', 'Nein Umbau'];

const DEFAULT_CHECKLIST_SCHEMA = [
  { type: 'header', text: 'In Kündigung' },
  { type: 'checkbox', text: 'Eigentümer informiert' },
  { type: 'checkbox', text: 'Kündigungsbestätigung verschickt' },
  { type: 'text-input', text: 'Haftbar bis' },
  { type: 'text-input', text: 'Abnahme am' },
  { type: 'spacer' },
  { type: 'header', text: 'In Vermietung' },
  { type: 'group', name: 'Mietzinsfelder', items: [
    { type: 'text-input', text: 'Neuer Mietzins netto' },
    { type: 'text-input', text: 'Neue Nebenkosten' },
    { type: 'text-input', text: 'Neuer Mietzins brutto' },
  ]},
  { type: 'spacer' },
  { type: 'checkbox', text: 'Inserat erstellen' },
  { type: 'checkbox', text: 'Besichtigungen durchführen' },
  { type: 'checkbox', text: 'Prüfen Referenzen, OK von Eigentümer' },
  { type: 'checkbox', text: 'Mietvertrag inkl. Beilagen und Kaution verschickt' },
  { type: 'checkbox', text: 'Mietvertrag unterzeichnet retour' }, 
  { type: 'checkbox', text: 'Inserat archiviert bzw. bei Flatfox "entfernt"' },
  { type: 'spacer' },
  { type: 'header', text: 'Mietvertrag erstellt' },
  { type: 'checkbox', text: 'RIMO: Mietzins definitiv setzen' },
  { type: 'checkbox', text: 'Namensschilder etc. bestellen, ggf. Hauswart, Eigentümer informieren' },
  { type: 'checkbox', text: 'Kaution bezahlt' },
  { type: 'checkbox', text: '1. Monatsmiete bezahlt' },
  { type: 'text-input', text: 'Übergabe am' },
  { type: 'spacer' },
  { type: 'header', text: 'Wohnung übergeben' },
  { type: 'checkbox', text: 'Meldungen an Ämter (Werke, Gemeinde)' },
  { type: 'checkbox', text: 'Evtl. Handwerker für Instandstellungen aufbieten' },
  { type: 'checkbox', text: 'Neues Mietvertragsdossier ablegen' },
  { type: 'checkbox', text: 'Schlussrechnung alter Mieter und Auszahlung Kaution' },
  { type: 'checkbox', text: 'Altes Mietvertragsdossier ablegen' },
];

// --- Hilfsfunktionen ---

const initializeChecklist = () => {
  return DEFAULT_CHECKLIST_SCHEMA.map(item => {
    if (item.type === 'group') return { ...item, items: item.items.map(si => ({ ...si, value: '' })) };
    if (item.type === 'checkbox') return { ...item, completed: false };
    if (['text-input', 'date-input', 'number-input'].includes(item.type)) return { ...item, value: '' };
    return { ...item };
  });
};

const isStatusComplete = (apartment, statusName) => {
  let inSection = false;
  let itemsInSection = 0;
  let itemsCompleted = 0;

  for (let item of apartment.checklist) {
    if (item.type === 'header') {
      if (item.text === statusName) { inSection = true; continue; }
      else if (inSection) break;
    }
    if (inSection) {
      if (item.type === 'spacer') continue;
      itemsInSection++;
      if (item.type === 'checkbox' && item.completed) itemsCompleted++;
      if (item.type === 'text-input' && item.value?.trim()) itemsCompleted++;
      if (item.type === 'group') {
        const groupComplete = item.items.every(si => si.value?.trim());
        if (groupComplete) itemsCompleted++;
      }
    }
  }
  return itemsInSection > 0 && itemsInSection === itemsCompleted;
};

const formatDate = (ds) => ds?.split('-').reverse().join('.') || '';

const getDaysSince = (ts) => {
  if (!ts) return 0;
  const last = ts.seconds ? new Date(ts.seconds * 1000) : new Date(ts);
  const now = new Date();
  const diff = Math.floor((now - last) / (1000 * 60 * 60 * 24));
  return isNaN(diff) ? 0 : Math.max(0, diff);
};

const getActivityColor = (days) => {
  if (days >= 15) return 'text-red-600';
  if (days >= 7) return 'text-yellow-600';
  return 'text-black';
};

const formatDateTime = (isoString) => {
  if (!isoString) return '';
  const date = new Date(isoString);
  return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
};

// --- Teil-Komponenten ---

const Modal = ({ show, title, message, onConfirm, onCancel, type = 'alert' }) => {
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[150] p-4 backdrop-blur-sm">
      <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full animate-in fade-in zoom-in duration-200 border border-slate-200">
        <h3 className="text-xl font-bold text-gray-900 mb-2">{title}</h3>
        <p className="text-gray-600 mb-6">{String(message)}</p>
        <div className="flex justify-end gap-3">
          {type === 'confirm' && (
            <button onClick={onCancel} className="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition font-bold uppercase text-xs">Abbrechen</button>
          )}
          <button onClick={onConfirm} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold uppercase text-xs">OK</button>
        </div>
      </div>
    </div>
  );
};

const NewTenantPopup = ({ show, onSave, initialName, initialDate }) => {
  const [name, setName] = useState(initialName || '');
  const [date, setDate] = useState(initialDate || '');
  useEffect(() => { if (show) { setName(initialName || ''); setDate(initialDate || ''); } }, [show, initialName, initialDate]);
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[200] p-4 backdrop-blur-md">
      <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border-4 border-blue-600 animate-in zoom-in duration-300">
        <h3 className="text-2xl font-black text-slate-800 mb-2 uppercase tracking-tighter">Neuvermietung</h3>
        <p className="text-slate-500 text-sm mb-8 font-medium italic">Bitte Name und Mietbeginn zwingend erfassen.</p>
        <div className="space-y-4 mb-10">
          <div className="bg-gray-50 p-4 rounded-2xl border border-gray-200">
            <label className="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-widest">Name des neuen Mieters</label>
            <input type="text" autoFocus value={name} onChange={e => setName(e.target.value)} placeholder="Vorname Nachname" className="w-full bg-transparent font-black text-gray-800 text-lg outline-none" />
          </div>
          <div className="bg-gray-50 p-4 rounded-2xl border border-gray-200">
            <label className="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-widest">Mietbeginn</label>
            <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full bg-transparent font-black text-gray-800 text-lg outline-none" />
          </div>
        </div>
        <button onClick={() => name.trim() && date && onSave(name, date)} disabled={!name.trim() || !date} className="w-full py-5 rounded-2xl font-black text-white bg-blue-600 shadow-xl disabled:bg-slate-300 transition active:scale-95 uppercase tracking-widest">Speichern & Fortfahren</button>
      </div>
    </div>
  );
};

const ApartmentDetailsModal = ({
  apartment, onClose, onStatusChange, onResponsibleChange, onUpdateTerminationDate, onUpdateRentalDetails,
  onChecklistItemUpdate, onAddCustomChecklistItem, onDeleteChecklistItem, onAddComment,
  teamMembers, statusOptions, statusColors, onNavigate, hasPrev, hasNext
}) => {
  const [newChecklistItemText, setNewChecklistItemText] = useState('');
  const [newCommentText, setNewCommentText] = useState('');
  const [showTenantPopup, setShowTenantPopup] = useState(false);
  const [manualCollapse, setManualCollapse] = useState({});
  const commentsRef = useRef(null);
  
  const days = getDaysSince(apartment.lastActivity);
  const activityColor = getActivityColor(days);
  const headerBg = statusColors[apartment.status] ? statusColors[apartment.status].split(' ')[0] : 'bg-white';
  const borderTopColor = statusColors[apartment.status] ? statusColors[apartment.status].split(' ')[1] : 'border-gray-200';

  const scrollToComments = () => {
    commentsRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  const handleCommentSubmit = () => {
    if (newCommentText.trim()) {
      onAddComment(apartment.id, newCommentText);
      setNewCommentText('');
    }
  };

  const toggleSection = (title) => {
    setManualCollapse(prev => ({ ...prev, [title]: !isSectionCollapsed(title) }));
  };

  const isSectionCollapsed = (title) => {
    if (manualCollapse[title] !== undefined) return manualCollapse[title];
    return isStatusComplete(apartment, title);
  };

  const sortedComments = useMemo(() => {
    return apartment.comments ? [...apartment.comments].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) : [];
  }, [apartment.comments]);

  return (
    <>
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
        {/* Fixed Navigation Buttons */}
        {hasPrev && (
          <button onClick={() => onNavigate(-1)} className="fixed left-6 md:left-12 top-1/2 -translate-y-1/2 w-16 h-16 bg-white shadow-2xl text-blue-600 rounded-full transition-all z-[110] hover:scale-110 active:scale-90 border border-slate-100 flex items-center justify-center group">
            <svg className="w-8 h-8 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="3"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /></svg>
          </button>
        )}
        {hasNext && (
          <button onClick={() => onNavigate(1)} className="fixed right-6 md:right-12 top-1/2 -translate-y-1/2 w-16 h-16 bg-white shadow-2xl text-blue-600 rounded-full transition-all z-[110] hover:scale-110 active:scale-90 border border-slate-100 flex items-center justify-center group">
            <svg className="w-8 h-8 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="3"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>
          </button>
        )}

        <div className={`bg-white rounded-[2rem] shadow-2xl w-full max-w-5xl h-full max-h-[92vh] overflow-y-auto border-t-[12px] ${borderTopColor} animate-in slide-in-from-bottom duration-300`}>
          <div className={`${headerBg} p-8 sticky top-0 z-20 border-b flex justify-between items-center transition-colors duration-500 shadow-sm`}>
            <div>
              <h3 className="text-3xl font-black text-gray-900 tracking-tighter leading-tight">{apartment.address}</h3>
              <p className="text-gray-500 font-bold uppercase text-xs tracking-widest mt-1">{apartment.objectName}</p>
            </div>
            <div className="flex items-center gap-8">
              {apartment.comments?.length > 0 && (
                <button 
                  onClick={scrollToComments}
                  className="bg-white/60 p-2 rounded-xl flex items-center gap-2 border border-white/80 shadow-sm text-indigo-600 hover:bg-white transition-all hover:scale-110"
                >
                   <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                   <span className="font-black text-xs">{apartment.comments.length}</span>
                </button>
              )}
              <div className="text-right bg-white/40 p-2 px-4 rounded-2xl border border-white/50">
                <span className="text-[9px] font-black uppercase text-gray-400 block tracking-widest leading-none mb-1">Letzte Aktivität</span>
                <span className={`font-black text-sm ${activityColor}`}>vor {days} Tag{days !== 1 ? 'en' : ''}</span>
              </div>
              <button onClick={onClose} className="p-3 bg-white hover:bg-gray-100 rounded-full transition shadow-md border border-slate-200">
                <svg className="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
            </div>
          </div>

          <div className="p-10">
            {/* Abgehobener Stammdaten-Bereich */}
            <div className="bg-slate-100/80 p-8 rounded-[2.5rem] border-2 border-slate-200 mb-12 shadow-inner">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="space-y-6">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-red-100/50 p-5 rounded-2xl border border-red-200 shadow-sm">
                      <label className="text-[10px] font-black text-red-500 uppercase mb-1 block tracking-wider">Alter Mieter</label>
                      <p className="font-black text-red-900 text-xl tracking-tight">{apartment.oldTenant}</p>
                    </div>
                    <div className="bg-red-100/50 p-5 rounded-2xl border border-red-200 shadow-sm">
                      <label className="text-[10px] font-black text-red-500 uppercase mb-1 block tracking-wider">Kündigung per</label>
                      <input type="date" value={apartment.terminationDate} onChange={e => onUpdateTerminationDate(apartment.id, e.target.value)} className="w-full bg-transparent font-black text-red-900 text-xl outline-none" />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-4 animate-in fade-in slide-in-from-top duration-500">
                    <div className="bg-green-100/50 p-5 rounded-2xl border border-green-200 shadow-sm">
                      <label className="text-[10px] font-black text-green-600 uppercase mb-1 block tracking-wider">Neuer Mieter</label>
                      <input type="text" placeholder="Noch offen..." value={apartment.newTenant || ''} onChange={e => onUpdateRentalDetails(apartment.id, e.target.value, apartment.rentalStart)} className="w-full bg-transparent font-black text-green-800 text-xl outline-none placeholder-green-300" />
                    </div>
                    <div className="bg-green-100/50 p-5 rounded-2xl border border-green-200 shadow-sm">
                      <label className="text-[10px] font-black text-green-600 uppercase mb-1 block tracking-wider">Mietbeginn</label>
                      <input type="date" value={apartment.rentalStart || ''} onChange={e => onUpdateRentalDetails(apartment.id, apartment.newTenant, e.target.value)} className="w-full bg-transparent font-black text-green-900 text-xl outline-none" />
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-6">
                  <div className="bg-white p-5 rounded-2xl border border-slate-300 shadow-sm">
                    <label className="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-widest">Status</label>
                    <select value={apartment.status} onChange={e => onStatusChange(apartment.id, e.target.value)} className="w-full bg-transparent font-black text-slate-800 text-xl outline-none cursor-pointer">
                      {statusOptions.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                  </div>
                  <div className="bg-white p-5 rounded-2xl border border-slate-300 shadow-sm">
                    <label className="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-widest">Zuständig</label>
                    <select value={apartment.responsible} onChange={e => onResponsibleChange(apartment.id, e.target.value)} className="w-full bg-transparent font-black text-slate-800 text-xl outline-none cursor-pointer">
                      {TEAM_MEMBERS.map(m => <option key={m} value={m}>{m}</option>)}
                    </select>
                  </div>
                </div>
              </div>
            </div>

            {/* Markanter Trenner vor der Checkliste */}
            <div className="flex items-center gap-6 mb-12">
              <div className="h-1 bg-slate-200 flex-1 rounded-full"></div>
              <span className="font-black text-slate-400 uppercase tracking-[0.5em] text-[10px] whitespace-nowrap">Prozess-Abwicklung</span>
              <div className="h-1 bg-slate-200 flex-1 rounded-full"></div>
            </div>

            <section className="space-y-8">
              <h4 className="text-2xl font-black text-slate-800 flex items-center gap-3 uppercase tracking-tighter">
                <svg className="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                Aufgaben
              </h4>
              <div className="bg-white border-2 border-slate-100 rounded-[2rem] overflow-hidden shadow-xl">
                {(() => {
                  let currentHeader = null;
                  return apartment.checklist.map((item, idx) => {
                    if (item.type === 'header') {
                      currentHeader = item.text;
                      const collapsed = isSectionCollapsed(item.text);
                      const color = STATUS_COLORS[item.text] ? STATUS_COLORS[item.text].split(' ')[0] : 'bg-gray-100';
                      return (
                        <div 
                          key={idx} 
                          onClick={() => toggleSection(item.text)}
                          className={`${color} p-4 border-b-2 border-white/50 mt-10 first:mt-0 font-black text-[13px] uppercase tracking-[0.25em] text-gray-700 shadow-inner px-8 flex items-center justify-between cursor-pointer group transition-all`}
                        >
                          <div className="flex items-center gap-4">
                            <div className={`p-1 rounded-lg bg-white/40 transition-transform duration-300 ${collapsed ? '-rotate-90' : ''}`}>
                              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="4"><path d="M19 9l-7 7-7-7" /></svg>
                            </div>
                            {item.text}
                          </div>
                          {isStatusComplete(apartment, item.text) && (
                            <span className="bg-green-500 text-white text-[9px] px-2 py-1 rounded-full shadow-sm">ERLEDIGT</span>
                          )}
                        </div>
                      );
                    }
                    if (item.type === 'spacer') return <div key={idx} className="h-4" />;
                    if (currentHeader && isSectionCollapsed(currentHeader)) return null;

                    return (
                      <div key={idx} className="p-5 border-b last:border-b-0 hover:bg-slate-50/50 flex flex-col gap-2 transition duration-200 px-8">
                        {item.type === 'checkbox' ? (
                          <label className={`flex items-center justify-between cursor-pointer select-none ${item.completed ? 'text-slate-300' : 'font-bold text-slate-700'}`}>
                            <div className="flex items-center gap-4">
                              <input type="checkbox" checked={item.completed} onChange={e => {
                                onChecklistItemUpdate(apartment.id, idx, e.target.checked, 'checkbox');
                                if (item.text === 'Mietvertrag unterzeichnet retour' && e.target.checked && (!apartment.newTenant || !apartment.rentalStart)) setShowTenantPopup(true);
                              }} className="w-6 h-6 rounded-lg border-2 border-slate-300 text-blue-600 focus:ring-blue-500 transition-all cursor-pointer" />
                              <span className={`text-[15px] ${item.completed ? 'line-through' : ''}`}>{item.text}</span>
                            </div>
                            <button onClick={() => onDeleteChecklistItem(apartment.id, idx)} className="text-slate-200 hover:text-red-500 transition-colors p-1"><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                          </label>
                        ) : item.type === 'group' ? (
                          <div className="grid grid-cols-3 gap-6">
                            {item.items.map((si, sidx) => (
                              <div key={sidx}>
                                <label className="text-[10px] font-black text-slate-400 uppercase block mb-1 tracking-widest">{si.text}</label>
                                <input type="text" value={si.value} onChange={e => { const up = { ...item }; up.items[sidx].value = e.target.value; onChecklistItemUpdate(apartment.id, idx, up, 'group'); }} className="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl text-sm font-black shadow-inner outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all" />
                              </div>
                            ))}
                          </div>
                        ) : (item.type === 'text-input') ? (
                          <div>
                            <label className="text-[10px] font-black text-slate-400 uppercase block mb-1 tracking-widest">{item.text}</label>
                            <input type="text" value={item.value} onChange={e => onChecklistItemUpdate(apartment.id, idx, e.target.value, 'text-input')} className="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl text-sm font-black shadow-inner outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all" />
                          </div>
                        ) : null}
                      </div>
                    );
                  });
                })()}
                <div className="p-6 bg-slate-50/50 flex gap-3 border-t-2 border-slate-100 px-8">
                  <input type="text" value={newChecklistItemText} onChange={(e) => setNewChecklistItemText(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && (onAddCustomChecklistItem(apartment.id, newChecklistItemText), setNewChecklistItemText(''))} placeholder="Zusätzliche Aufgabe erfassen..." className="flex-1 p-3 border-2 border-slate-200 rounded-xl text-sm font-bold outline-none shadow-sm bg-white focus:ring-4 focus:ring-blue-500/10 transition-all" />
                  <button onClick={() => { onAddCustomChecklistItem(apartment.id, newChecklistItemText); setNewChecklistItemText(''); }} className="bg-blue-600 text-white px-8 py-3 rounded-xl text-sm font-black shadow-lg shadow-blue-200 hover:bg-blue-700 transition active:scale-95 uppercase tracking-widest">Hinzufügen</button>
                </div>
              </div>
            </section>

            {/* Kommentarbereich mit Ref für Scroll-Navigation */}
            <section className="mt-16 space-y-8" ref={commentsRef}>
              <h4 className="text-2xl font-black text-slate-800 flex items-center gap-3 uppercase tracking-tighter">
                <svg className="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                Kommentare
              </h4>
              <div className="space-y-6">
                <div className="flex gap-3">
                  <input type="text" value={newCommentText} onChange={(e) => setNewCommentText(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleCommentSubmit()} placeholder="Nachricht an das Team..." className="flex-1 p-4 border-2 border-slate-200 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all shadow-sm" />
                  <button onClick={handleCommentSubmit} className="bg-indigo-600 text-white px-10 py-3 rounded-2xl font-black shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition active:scale-95 uppercase tracking-widest">Senden</button>
                </div>
                <div className="space-y-4 max-h-[400px] overflow-y-auto pr-4 custom-scrollbar">
                  {sortedComments.length === 0 ? (
                    <div className="py-10 text-center text-slate-400 font-medium italic border-2 border-dashed border-slate-200 rounded-3xl">Noch keine Kommentare vorhanden.</div>
                  ) : sortedComments.map((c, i) => (
                    <div key={i} className="bg-white p-5 rounded-3xl border-2 border-slate-50 shadow-sm group hover:border-indigo-100 transition-all">
                      <p className="text-slate-800 font-medium leading-relaxed mb-3">{c.text}</p>
                      <div className="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                        <span className="flex items-center gap-1.5"><div className="w-1.5 h-1.5 rounded-full bg-indigo-400"></div>{c.user}</span>
                        <span>{formatDateTime(c.timestamp)}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
      <NewTenantPopup 
        show={showTenantPopup} 
        initialName={apartment.newTenant} 
        initialDate={apartment.rentalStart} 
        onSave={(n, d) => { onUpdateRentalDetails(apartment.id, n, d); setShowTenantPopup(false); }} 
      />
    </>
  );
};

// --- Hauptanwendung ---

function App() {
  const [user, setUser] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [apartments, setApartments] = useState([]);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showDetailsModal, setShowDetailsModal] = useState(false);
  const [selectedId, setSelectedId] = useState(null);
  const [modalProps, setModalProps] = useState({ show: false, title: '', message: '', type: 'alert' });
  const [currentView, setCurrentView] = useState('kanban');
  const [searchTerm, setSearchTerm] = useState('');
  const [filterResponsible, setFilterResponsible] = useState('Alle');
  
  const [sortConfig, setSortConfig] = useState({ key: 'terminationDate', direction: 'asc' });

  const [newApartment, setNewApartment] = useState({
    address: '', objectName: '', oldTenant: '', terminationDate: '',
    status: STATUS_OPTIONS[0], responsible: TEAM_MEMBERS[0],
    relettingOption: RELETTING_OPTIONS[0], comments: [],
    checklist: initializeChecklist(), newTenant: '', rentalStart: ''
  });

  useEffect(() => {
    const initAuth = async () => {
      try {
        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (token) await signInWithCustomToken(auth, token); else await signInAnonymously(auth);
      } catch (e) { console.error(e); }
    };
    initAuth();
    const unsub = onAuthStateChanged(auth, u => { setUser(u); if (u) setIsAuthReady(true); });
    return () => unsub();
  }, []);

  useEffect(() => {
    if (!user || !isAuthReady) return;
    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'apartments');
    const unsub = onSnapshot(colRef, s => {
      setApartments(s.docs.map(d => ({ id: d.id, ...d.data() })));
    }, err => console.error("Firestore Permission Error:", err));
    return () => unsub();
  }, [user, isAuthReady]);

  const requestSort = (key) => {
    let direction = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
    setSortConfig({ key, direction });
  };

  const filtered = useMemo(() => {
    const base = apartments.filter(a => {
      const s = searchTerm.toLowerCase();
      const matchSearch = !searchTerm || a.address.toLowerCase().includes(s) || a.oldTenant.toLowerCase().includes(s) || a.objectName.toLowerCase().includes(s) || a.newTenant?.toLowerCase().includes(s);
      const matchResp = filterResponsible === 'Alle' || a.responsible === filterResponsible;
      return matchSearch && matchResp;
    });

    return [...base].sort((a, b) => {
      let valA = a[sortConfig.key] || '';
      let valB = b[sortConfig.key] || '';
      if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
      if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });
  }, [apartments, searchTerm, filterResponsible, sortConfig]);

  const byStatus = useMemo(() => STATUS_OPTIONS.reduce((acc, s) => { acc[s] = filtered.filter(a => a.status === s); return acc; }, {}), [filtered]);
  const selectedApartment = useMemo(() => filtered.find(a => a.id === selectedId), [filtered, selectedId]);

  const showModal = (title, message, type = 'alert', onConfirm = null) => {
    setModalProps({ show: true, title, message, type, onConfirm: () => { setModalProps(p => ({ ...p, show: false })); if (onConfirm) onConfirm(); }, onCancel: () => setModalProps(p => ({ ...p, show: false })) });
  };

  const updateApartmentData = async (id, data) => {
    try { 
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'apartments', id), { 
        ...data, 
        lastActivity: new Date().toISOString() 
      }); 
    } catch (e) { showModal('Fehler', 'Update fehlgeschlagen.'); }
  };

  const addApartment = async () => {
    if (!newApartment.address || !newApartment.objectName || !newApartment.oldTenant || !newApartment.terminationDate) {
      return showModal('Hinweis', 'Bitte füllen Sie alle erforderlichen Felder aus.');
    }
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'apartments'), {
        ...newApartment,
        createdAt: new Date().toISOString(),
        lastActivity: new Date().toISOString(),
        createdBy: user.email || user.uid
      });
      setShowAddModal(false);
      setNewApartment({ address: '', objectName: '', oldTenant: '', terminationDate: '', status: STATUS_OPTIONS[0], responsible: TEAM_MEMBERS[0], relettingOption: RELETTING_OPTIONS[0], comments: [], checklist: initializeChecklist(), newTenant: '', rentalStart: '' });
    } catch (e) { showModal('Fehler', 'Wohnung konnte nicht gespeichert werden.'); }
  };

  const deleteApartment = (id) => {
    showModal('Eintrag löschen', 'Soll dieser Datensatz wirklich dauerhaft entfernt werden?', 'confirm', async () => {
      try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'apartments', id)); }
      catch (e) { showModal('Fehler', 'Löschvorgang fehlgeschlagen.'); }
    });
  };

  const attemptStatusChange = (apartment, newStatus) => {
    const currIdx = STATUS_OPTIONS.indexOf(apartment.status);
    const newIdx = STATUS_OPTIONS.indexOf(newStatus);
    if (newIdx > currIdx && !isStatusComplete(apartment, apartment.status)) {
      showModal('Status-Sperre', `Bevor Sie zum Status "${newStatus}" wechseln können, müssen erst alle Aufgaben unter "${apartment.status}" erledigt sein.`);
      return false;
    }
    updateApartmentData(apartment.id, { status: newStatus });
    return true;
  };

  const navigateApartment = (dir) => {
    const idx = filtered.findIndex(a => a.id === selectedId);
    const nextIdx = idx + dir;
    if (nextIdx >= 0 && nextIdx < filtered.length) setSelectedId(filtered[nextIdx].id);
  };

  const SortIcon = ({ column }) => {
    if (sortConfig.key !== column) return <svg className="w-3 h-3 text-slate-300 ml-1 inline opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="3"><path strokeLinecap="round" strokeLinejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>;
    return sortConfig.direction === 'asc' 
      ? <svg className="w-3 h-3 text-blue-600 ml-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 15l7-7 7 7" /></svg>
      : <svg className="w-3 h-3 text-blue-600 ml-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M19 9l-7 7-7-7" /></svg>;
  };

  if (!isAuthReady) return (
    <div className="h-screen bg-slate-900 flex flex-col items-center justify-center gap-6">
      <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      <div className="font-black text-slate-500 uppercase tracking-[0.4em] text-sm">System Initialisierung...</div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#F1F5F9] flex flex-col font-sans antialiased text-slate-900">
      <header className="bg-white border-b sticky top-0 z-40 px-8 py-5 flex flex-col sm:flex-row justify-between items-center gap-4 shadow-sm">
        <div className="flex items-center gap-4">
          <div className="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg rotate-3">
            <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
          </div>
          <h1 className="text-3xl font-black tracking-tighter text-slate-800 uppercase">MietProzess</h1>
        </div>
        <button onClick={() => setShowAddModal(true)} className="bg-blue-600 text-white px-8 py-3 rounded-2xl font-black shadow-xl shadow-blue-200 transition-all hover:scale-105 active:scale-95 uppercase tracking-widest text-sm">
          + Neue Kündigung erfassen
        </button>
      </header>

      <main className="flex-1 flex flex-col min-h-0">
        <div className="p-8 pb-4">
          <div className="bg-white p-5 rounded-[2rem] border-2 border-slate-100 shadow-sm flex flex-wrap items-center gap-6">
            <div className="flex-1 min-w-[300px] relative">
              <input type="text" placeholder="Suche nach Adresse, Mieter oder Objekt..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-3 bg-slate-50 border-none rounded-2xl focus:ring-4 focus:ring-blue-500/10 font-bold transition-all" />
              <svg className="w-6 h-6 absolute left-4 top-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
            <select value={filterResponsible} onChange={e => setFilterResponsible(e.target.value)} className="bg-slate-50 border-none rounded-2xl py-3 px-6 font-black text-sm outline-none cursor-pointer hover:bg-slate-100 transition-colors">
              <option value="Alle">Alle Zuständigkeiten</option>
              {TEAM_MEMBERS.map(m => <option key={m} value={m}>{m}</option>)}
            </select>
            <div className="flex bg-slate-100 p-1.5 rounded-2xl shadow-inner border border-slate-200/50">
              <button onClick={() => setCurrentView('kanban')} className={`px-6 py-2 rounded-xl text-xs font-black tracking-widest transition-all ${currentView === 'kanban' ? 'bg-white shadow-lg text-blue-600 scale-105' : 'text-slate-500 hover:text-slate-700'}`}>KANBAN</button>
              <button onClick={() => setCurrentView('list')} className={`px-6 py-2 rounded-xl text-xs font-black tracking-widest transition-all ${currentView === 'list' ? 'bg-white shadow-lg text-blue-600 scale-105' : 'text-slate-500 hover:text-slate-700'}`}>LISTE</button>
            </div>
          </div>
        </div>

        {currentView === 'kanban' ? (
          <div className="flex-1 overflow-x-auto p-8 pt-4 flex gap-8 min-h-0 custom-scrollbar">
            {STATUS_OPTIONS.map(status => (
              <div key={status} onDragOver={e => e.preventDefault()} onDrop={e => { e.preventDefault(); const id = e.dataTransfer.getData("apId"); const ap = apartments.find(a => a.id === id); if (ap) attemptStatusChange(ap, status); }} className="flex-shrink-0 w-80 flex flex-col gap-6">
                <div className="flex items-center justify-between px-4">
                  <h3 className="text-[12px] font-black text-slate-500 uppercase tracking-[0.2em] flex items-center gap-3">
                    <span className={`w-3 h-3 rounded-full shadow-sm ${STATUS_COLORS[status].split(' ')[1].replace('border-', 'bg-')}`}></span>
                    {status}
                  </h3>
                  <span className="bg-white border-2 border-slate-100 text-slate-400 text-[10px] font-black px-3 py-1 rounded-full shadow-sm">{byStatus[status].length}</span>
                </div>
                <div className="flex-1 space-y-5 overflow-y-auto pr-3 custom-scrollbar min-h-[100px]">
                  {byStatus[status].map(ap => {
                    const d = getDaysSince(ap.lastActivity);
                    const aCol = getActivityColor(d);
                    return (
                      <div key={ap.id} draggable onDragStart={e => e.dataTransfer.setData("apId", ap.id)} onClick={() => { setSelectedId(ap.id); setShowDetailsModal(true); }} className="bg-white p-4 rounded-3xl border-2 border-slate-100 shadow-sm hover:shadow-xl hover:border-blue-300 hover:-translate-y-1 cursor-pointer transition-all group active:scale-[0.98] relative overflow-hidden">
                        <div className="absolute top-4 right-4 flex items-center gap-3">
                          {ap.comments?.length > 0 && (
                            <div className="text-indigo-400 flex items-center gap-1">
                               <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                               <span className="text-[10px] font-black">{ap.comments.length}</span>
                            </div>
                          )}
                          <div className="flex items-center gap-1.5 bg-slate-50 p-1 px-2 rounded-full border border-slate-100">
                            <svg className={`w-3.5 h-3.5 ${aCol}`} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span className={`text-[10px] font-black ${aCol}`}>{d}d</span>
                          </div>
                        </div>
                        <h4 className="font-black text-slate-800 group-hover:text-blue-600 transition truncate text-base max-w-[70%] tracking-tight mb-1">{ap.address}</h4>
                        <p className="text-[11px] text-slate-400 font-bold truncate mb-5 italic tracking-tight">{ap.objectName}</p>
                        
                        <div className="space-y-1.5">
                          <div className="flex gap-1.5">
                            <div className="flex-1 bg-red-50 p-1.5 rounded-xl border border-red-100 truncate text-center shadow-inner">
                              <span className="text-[11px] font-black text-red-700 tracking-tight">{ap.oldTenant}</span>
                            </div>
                            <div className="flex-1 bg-red-50 p-1.5 rounded-xl border border-red-100 truncate text-center shadow-inner">
                              <span className="text-[11px] font-black text-red-700 tracking-tight">{formatDate(ap.terminationDate)}</span>
                            </div>
                          </div>
                          {(ap.newTenant || ap.rentalStart) && (
                            <div className="flex gap-1 animate-in slide-in-from-top duration-300">
                              <div className="flex-1 bg-green-50 p-1.5 rounded-xl border border-green-100 truncate text-center shadow-inner">
                                <span className="text-[11px] font-black text-green-700 tracking-tight">{ap.newTenant || '-'}</span>
                              </div>
                              <div className="flex-1 bg-green-50 p-1.5 rounded-xl border border-green-100 truncate text-center shadow-inner">
                                <span className="text-[11px] font-black text-green-700 tracking-tight">{ap.rentalStart ? formatDate(ap.rentalStart) : '-'}</span>
                              </div>
                            </div>
                          )}
                          <div className="flex items-center justify-between gap-2 pt-3 border-t mt-2 border-slate-50">
                             <div className="flex items-center gap-2 overflow-hidden">
                               <div className="w-6 h-6 rounded-lg bg-slate-100 flex items-center justify-center">
                                 <svg className="w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                               </div>
                               <span className="text-[10px] font-black text-slate-400 uppercase truncate tracking-wider">{ap.responsible}</span>
                             </div>
                             <button onClick={(e) => { e.stopPropagation(); deleteApartment(ap.id); }} className="text-slate-200 hover:text-red-500 transition-colors p-1"><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="flex-1 p-8 overflow-y-auto">
            <div className="bg-white rounded-[2.5rem] border-2 border-slate-100 shadow-xl overflow-hidden">
              <table className="w-full text-left table-fixed">
                <thead className="bg-slate-50 border-b-2 border-slate-100">
                  <tr className="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <th onClick={() => requestSort('address')} className="px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group w-1/4">Adresse / Objekt <SortIcon column="address" /></th>
                    <th onClick={() => requestSort('oldTenant')} className="px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group">Alter Mieter <SortIcon column="oldTenant" /></th>
                    <th onClick={() => requestSort('terminationDate')} className="px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group">Kündigung per <SortIcon column="terminationDate" /></th>
                    <th onClick={() => requestSort('newTenant')} className="px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group">Neuer Mieter <SortIcon column="newTenant" /></th>
                    <th onClick={() => requestSort('rentalStart')} className="px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group">Mietbeginn <SortIcon column="rentalStart" /></th>
                    <th onClick={() => requestSort('status')} className="px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group">Status <SortIcon column="status" /></th>
                    <th onClick={() => requestSort('responsible')} className="px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group">Zuständig <SortIcon column="responsible" /></th>
                    <th onClick={() => requestSort('lastActivity')} className="px-6 py-5 cursor-pointer hover:bg-slate-100 transition-colors group text-center w-24">Aktivität <SortIcon column="lastActivity" /></th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-50 text-xs">
                  {filtered.map(ap => {
                    const d = getDaysSince(ap.lastActivity);
                    return (
                      <tr key={ap.id} onClick={() => { setSelectedId(ap.id); setShowDetailsModal(true); }} className="hover:bg-blue-50/40 cursor-pointer transition-colors group">
                        <td className="px-6 py-4">
                          <p className="font-black text-slate-800 tracking-tight truncate">{ap.address}</p>
                          <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5 truncate">{ap.objectName}</p>
                        </td>
                        <td className="px-6 py-4 truncate font-bold text-slate-600">{ap.oldTenant}</td>
                        <td className="px-6 py-4">
                           <span className="bg-red-50 text-red-700 px-2 py-1 rounded-lg font-black border border-red-100 shadow-sm">{formatDate(ap.terminationDate)}</span>
                        </td>
                        <td className="px-6 py-4 truncate font-bold text-blue-600">
                           {ap.newTenant || <span className="text-slate-300 italic font-bold">Offen</span>}
                        </td>
                        <td className="px-6 py-4">
                           {ap.rentalStart ? <span className="bg-green-50 text-green-700 px-2 py-1 rounded-lg font-black border border-green-100 shadow-sm">{formatDate(ap.rentalStart)}</span> : <span className="text-slate-300 italic font-bold">-</span>}
                        </td>
                        <td className="px-6 py-4">
                          <span className={`px-2 py-1 rounded-xl text-[9px] font-black uppercase tracking-widest ${STATUS_COLORS[ap.status]}`}>
                            {ap.status}
                          </span>
                        </td>
                        <td className="px-6 py-4 truncate font-bold text-slate-500">{ap.responsible}</td>
                        <td className="px-6 py-4 text-center">
                          <div className={`inline-flex items-center gap-1 font-black text-[10px] ${getActivityColor(d)}`}>
                            {d}d
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </main>

      {showAddModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[130] p-4 backdrop-blur-md">
          <div className="bg-white rounded-[2.5rem] shadow-2xl p-10 w-full max-w-xl animate-in zoom-in duration-300 border-4 border-slate-50" onClick={e => e.stopPropagation()}>
            <div className="flex items-center gap-4 mb-8">
               <div className="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="3"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg></div>
               <h3 className="text-3xl font-black text-slate-800 uppercase tracking-tighter">Neue Kündigung</h3>
            </div>
            <div className="space-y-6">
              <div className="grid grid-cols-1 gap-4">
                <div className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                   <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Adresse</label>
                   <input type="text" placeholder="Straße, PLZ Ort" value={newApartment.address} onChange={e => setNewApartment({...newApartment, address: e.target.value})} className="w-full bg-transparent font-black text-slate-800 text-lg outline-none" required />
                </div>
                <div className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                   <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Objekt</label>
                   <input type="text" placeholder="Zimmeranzahl, Lage" value={newApartment.objectName} onChange={e => setNewApartment({...newApartment, objectName: e.target.value})} className="w-full bg-transparent font-black text-slate-800 text-lg outline-none" required />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                   <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Alter Mieter</label>
                   <input type="text" placeholder="Vorname Nachname" value={newApartment.oldTenant} onChange={e => setNewApartment({...newApartment, oldTenant: e.target.value})} className="w-full bg-transparent font-black text-slate-800 text-lg outline-none" required />
                </div>
                <div className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                   <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Kündigung per</label>
                   <input type="date" value={newApartment.terminationDate} onChange={e => setNewApartment({...newApartment, terminationDate: e.target.value})} className="w-full bg-transparent font-black text-slate-800 text-lg outline-none" required />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                   <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Zuständigkeit</label>
                   <select value={newApartment.responsible} onChange={e => setNewApartment({...newApartment, responsible: e.target.value})} className="w-full bg-transparent font-black text-slate-800 text-lg outline-none cursor-pointer">{TEAM_MEMBERS.map(m => <option key={m} value={m}>{m}</option>)}</select>
                </div>
                <div className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                   <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Weitervermietung</label>
                   <select value={newApartment.relettingOption} onChange={e => setNewApartment({...newApartment, relettingOption: e.target.value})} className="w-full bg-transparent font-black text-slate-800 text-lg outline-none cursor-pointer">{RELETTING_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                </div>
              </div>
            </div>
            <div className="flex gap-4 mt-12">
              <button onClick={() => setShowAddModal(false)} className="flex-1 py-5 font-black text-slate-500 bg-slate-100 rounded-3xl transition hover:bg-slate-200 uppercase tracking-widest">Abbrechen</button>
              <button onClick={addApartment} className="flex-1 py-5 font-black text-white bg-blue-600 rounded-3xl shadow-2xl shadow-blue-200 transition active:scale-95 uppercase tracking-widest">Erfassen</button>
            </div>
          </div>
        </div>
      )}

      {showDetailsModal && selectedApartment && (
        <ApartmentDetailsModal
          apartment={selectedApartment}
          onClose={() => setShowDetailsModal(false)}
          onStatusChange={(id, s) => attemptStatusChange(selectedApartment, s)}
          onResponsibleChange={(id, r) => updateApartmentData(id, { responsible: r })}
          onUpdateTerminationDate={(id, d) => updateApartmentData(id, { terminationDate: d })}
          onUpdateRentalDetails={(id, n, d) => updateApartmentData(id, { newTenant: n, rentalStart: d })}
          onChecklistItemUpdate={(id, idx, val, type) => {
            const list = [...selectedApartment.checklist];
            if (type === 'checkbox') list[idx].completed = val; else if (type === 'group') list[idx] = val; else list[idx].value = val;
            updateApartmentData(id, { checklist: list });
          }}
          onAddCustomChecklistItem={(id, text) => {
            if (!text.trim()) return;
            const list = [...selectedApartment.checklist, { type: 'checkbox', text, completed: false }];
            updateApartmentData(id, { checklist: list });
          }}
          onDeleteChecklistItem={(id, idx) => {
            const list = selectedApartment.checklist.filter((_, i) => i !== idx);
            updateApartmentData(id, { checklist: list });
          }}
          onAddComment={(id, text) => {
            const com = [...(selectedApartment.comments || []), { text, timestamp: new Date().toISOString(), user: user.email || 'System' }];
            updateApartmentData(id, { comments: com });
          }}
          teamMembers={TEAM_MEMBERS}
          statusOptions={STATUS_OPTIONS}
          statusColors={STATUS_COLORS}
          onNavigate={navigateApartment}
          hasPrev={filtered.findIndex(a => a.id === selectedId) > 0}
          hasNext={filtered.findIndex(a => a.id === selectedId) < filtered.length - 1}
        />
      )}

      <Modal {...modalProps} />

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.03); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94A3B8; border: 2px solid transparent; background-clip: content-box; }
      `}</style>
    </div>
  );
}

export default App;